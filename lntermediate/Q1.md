# 浏览器如何渲染页面

## CSS和JS在网页中的放置顺序是怎样的？

CSS应该放在页面顶部的`head`标签中

>由于 Render Tree 是由 DOM 树和 CSSOM 树组合成的，HTML 页面需要等到 CSS 解析完后才能完成渲染，所以 CSS 应放在`head`标签内，优先下载解析，以避免页面元素由于样式缺失造成瞬间的白页或者给用户闪烁感。

JS 应该放在`body`的底部

>因为浏览器需要一个稳定的 DOM 树结构，而且 JavaScript 中很有可能有代码直接改变了 DOM 树结构，浏览器为了防止出现 JavaScript 修改 DOM 树，需要重新构建 DOM 树的情况，所以就会阻塞其他的下载和呈现。
>
>将 JavaScript 放在 head 内和 body 底部的区别也在于此，放在 head 里面，由于浏览器发现 head 里面有 JavaScript 标签就会暂时停止其他渲染行为，等待 JavaScript 下载并执行完成才能接着往下渲染，而这个时候由于在 head 里面这个时候页面是白的；如果将 JavaScript 放在页面底部，Render Tree 已经完成大部分，所以此时页面有内容呈现，即使遇到 JavaScript 阻塞渲染，也不会有白屏出现

如果 CSS 和 JS 都在`head`标签内，则应将 JS 放在所有 CSS 的前面

>JavaScript 的执行有可能依赖最新样式。比如，可能会有`var width=$('#id').width`，这意味着，JavaScript 代码在执行前，浏览器必须保证在此 JavaScript 之前的所有 CSS（无论外链还是内嵌）都已下载和解析完成。

把 JS 放在 CSS 后会导致页面阻塞，去等待 CSS 的下载。
另外如果要在`head`引入 JS 尽量将 JS 内嵌。

[参考文章](http://www.jianshu.com/p/0291ad9ac8fb)

## 解释白屏和FOUC

**白屏（blank white screen）：**在浏览器和用户等待位于底部的样式表时，浏览器会延迟显示任何可视化组件，即所谓的白屏现象。

**无样式内容闪烁（FOUC）：**页面在样式表下载解析之前，组件就已经逐步加载显示，当样式表解析完成后，已经显示的组件就要用新的样式进行绘制，这就导致所 谓的无样式内容闪烁。

原因解释：

1. 在Firefox浏览器里，无论是将样式表置于顶部还是底部，总是采用逐步呈现的方式来加载组件（component）。因此，若样式表不是最初页面呈现所必需的，则用户用户基本感觉不到有什么差别（当然加载时间是不一样的，最后会稍微再补充一下）；而当样式表为页面程序所必需的时候，则会出现无样式内容闪烁现象（不难想象那个过程）。
2. 在Internet Explorer里，则稍微复杂一点。想象一下，如果现在页面组件已经加载显示完毕，但CSS样式表一秒后才慢悠悠地加载解析完毕（这种极端情况很少会出现，但的确有助于我们理解白屏出现原因），这个时候坐在计算机前的用户就会发现原先显示的页面所呈现的方式跟最初见到的不一样（也许正文字体颜色由黑色变成了红色，链接上面的下划线离奇消失了）。这种用户体验其实是很差的，为了防止这种情况的出现，IE浏览器会阻止页面的逐步呈现直至样式表加载解析完毕，然后页面所有内容同时涌上计算机屏幕。不过貌似这种白屏现象的用户体验更差其实（不知道是出于什么考虑采取了这种呈现方式）。不过出现白屏也是在具体情况下才会出现，上面已经总结了三点，这里不赘述。

[参考文章](http://www.cnblogs.com/chyingp/archive/2010/10/14/1851341.html)

## async和defer的作用是什么？有什么区别

`async`和`defer`可以达到不阻塞渲染的效果

带有 `defer` 属性的`<script>`标签可以放置在文档的任何位置。对应的 JavaScript 文件将在页面解析到`<script>`标签时开始下载，但不会执行，直到 DOM 加载完成，即onload事件触发前才会被执行。当一个带有 `defer`属性的 JavaScript 文件下载时，它不会阻塞浏览器的其他进程，因此这类文件可以与其他资源文件一起并行下载。

但是

>`defer` 属性只被 IE 4 和 Firefox 3.5 更高版本的浏览器所支持，所以它不是一个理想的跨浏览器解决方案。在其他浏览器中，`defer`属性会被直接忽略，因此`<script>`标签会以默认的方式处理，也就是说会造成阻塞。然而，如果您的目标浏览器支持的话，这仍然是个有用的解决方案。

`async`的作用和 `defer`一样，能够异步地加载和执行脚本，不因为加载脚本而阻塞页面的加载。

但是

>在有 `async` 的情况下，JavaScript 脚本一旦下载好了就会执行，所以很有可能不是按照原本的顺序来执行的。如果 JavaScript 脚本前后有依赖性，使用 `async` 就很有可能出现错误。

[参考文章](http://www.jianshu.com/p/0291ad9ac8fb)

JavaScript 高级程序设计 P13-14

## 简述网页的渲染机制

- 解析html构建DOM树
- 解析CSS构建CSSOM树
- 把DOM和CSSOM组合成渲染树（Render Tree）
- 在渲染树的基础上进行布局，计算每个节点的几何结构（Layout Tree）
- 把每个节点绘制到屏幕上（Painting）

![](https://leanote.com/api/file/getImage?fileId=574e5225ab64413fd70241ce)

>当浏览器从服务器接收到了html文档，并把html在内存中转换成DOM树，在转换过程中如果发现某个节点上引用了CSS或者image，就会再发一个request去请求CSS或image，然后继续执行下面的转换，而不需要等待request的返回，当request返回后，只需要把返回的内容放入到DOM树中对应的位置就可以了。但当引用了JS的时候，浏览器发送一个JS request就会一直等待该request的返回。

[参考文章1](http://www.jianshu.com/p/0291ad9ac8fb)

[参考文章2](http://taligarsiel.com/Projects/howbrowserswork1.htm)